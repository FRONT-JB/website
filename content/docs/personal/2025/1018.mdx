---
title: "10ì›” 18ì¼"
description: "2025ë…„ 10ì›” 18ì¼ì— ê¸°ë¡í•œ ë‚´ìš©"
---

## ì˜¤ëŠ˜ ë°°ìš´ ê²ƒ (TIL)

Next.js 15 í™˜ê²½ì—ì„œ ì™¸ë¶€ ë°±ì—”ë“œ APIì™€ httpOnly/secure ì¿ í‚¤ë¥¼ ì‚¬ìš©í•œ ì¸ì¦ ì‹œìŠ¤í…œ êµ¬í˜„

## í•µì‹¬ ìš”ì•½ (TL;DR)

Next.js 15ì™€ ë³„ë„ì˜ ë°±ì—”ë“œ API ì„œë²„ ê°„ ì¿ í‚¤ ê¸°ë°˜ ì¸ì¦ ì‹œìŠ¤í…œ êµ¬í˜„ ë°©ë²• í•™ìŠµ. `credentials: 'include'`ë¥¼ í†µí•œ ìë™ ì¿ í‚¤ ì „ì†¡, ì•¡ì„¸ìŠ¤/ë¦¬í”„ë ˆì‹œ í† í° ê°±ì‹  í”Œë¡œìš°, Server Actionsì™€ Middlewareì—ì„œì˜ ì¿ í‚¤ ì²˜ë¦¬, Set-Cookie í—¤ë” íŒŒì‹± ë“± í”„ë¡ íŠ¸ì—”ë“œ-ë°±ì—”ë“œ ë¶„ë¦¬ í™˜ê²½ì—ì„œì˜ ì•ˆì „í•œ ì¸ì¦ êµ¬í˜„ íŒ¨í„´ ìŠµë“.

---

## Next.js 15 + ì™¸ë¶€ ë°±ì—”ë“œ API ì¿ í‚¤ ì¸ì¦ ì‹œìŠ¤í…œ

### ì•„í‚¤í…ì²˜ ê°œìš”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Next.js 15    â”‚          â”‚  Backend API     â”‚
â”‚   (Frontend)    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                  â”‚
â”‚                 â”‚  Cookie  â”‚  - Access Token  â”‚
â”‚  - Server Comp  â”‚          â”‚  - Refresh Token â”‚
â”‚  - Server Actionâ”‚          â”‚  (httpOnly)      â”‚
â”‚  - Middleware   â”‚          â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**í•µì‹¬ ê°œë…**:

- ë°±ì—”ë“œê°€ Set-Cookieë¡œ httpOnly ì¿ í‚¤ ë°œê¸‰
- ë¸Œë¼ìš°ì €ê°€ ìë™ìœ¼ë¡œ ì¿ í‚¤ ì €ì¥ ë° ì „ì†¡
- Next.jsëŠ” `credentials: 'include'`ë¡œ ì¿ í‚¤ ìë™ í¬í•¨
- JavaScriptì—ì„œ ì¿ í‚¤ ì§ì ‘ ì ‘ê·¼ ë¶ˆê°€ (ë³´ì•ˆ)

---

## 1. ì¿ í‚¤ ì†ì„± ì´í•´

### ë°±ì—”ë“œ ì‘ë‹µ ì˜ˆì‹œ

```http
Set-Cookie: accessToken=eyJhbG...; Path=/; HttpOnly; Secure; SameSite=Lax; Max-Age=900
Set-Cookie: refreshToken=eyJhbG...; Path=/api/auth/refresh; HttpOnly; Secure; SameSite=Lax; Max-Age=604800
```

### ì¿ í‚¤ ì†ì„± ì •ë¦¬

| ì†ì„±             | ì„¤ëª…                    | ë³´ì•ˆ íš¨ê³¼          |
| ---------------- | ----------------------- | ------------------ |
| **HttpOnly**     | JavaScript ì ‘ê·¼ ì°¨ë‹¨    | XSS ê³µê²© ë°©ì§€      |
| **Secure**       | HTTPSì—ì„œë§Œ ì „ì†¡        | MITM ê³µê²© ë°©ì§€     |
| **SameSite=Lax** | í¬ë¡œìŠ¤ ì‚¬ì´íŠ¸ ìš”ì²­ ì œí•œ | CSRF ê³µê²© ë°©ì§€     |
| **Path**         | ì¿ í‚¤ ì „ì†¡ ê²½ë¡œ ì œí•œ     | ë¶ˆí•„ìš”í•œ ë…¸ì¶œ ë°©ì§€ |
| **Max-Age**      | ë§Œë£Œ ì‹œê°„ (ì´ˆ)          | í† í° ìƒëª…ì£¼ê¸° ê´€ë¦¬ |

**Path ë¶„ë¦¬ ì „ëµ**:

- `accessToken`: `Path=/` â†’ ëª¨ë“  API ìš”ì²­ì— í¬í•¨
- `refreshToken`: `Path=/api/auth/refresh` â†’ ë¦¬í”„ë ˆì‹œ ì—”ë“œí¬ì¸íŠ¸ì—ë§Œ í¬í•¨

---

## 2. API í´ë¼ì´ì–¸íŠ¸ êµ¬í˜„ (í•µì‹¬)

### lib/api-client.ts

```typescript
export async function apiClient<T>(
  endpoint: string,
  options: FetchOptions = {},
): Promise<T> {
  const config: RequestInit = {
    ...options,
    // ğŸ”‘ í•µì‹¬: credentialsë¥¼ 'include'ë¡œ ì„¤ì •
    credentials: "include", // ì¿ í‚¤ ìë™ ì „ì†¡
    headers: {
      "Content-Type": "application/json",
      ...options.headers,
    },
  };

  let response = await fetch(`${API_BASE_URL}${endpoint}`, config);

  // 401 Unauthorized â†’ í† í° ê°±ì‹  ì‹œë„
  if (response.status === 401 && requiresAuth) {
    const refreshed = await refreshAccessToken();

    if (refreshed) {
      // ì›ë˜ ìš”ì²­ ì¬ì‹œë„
      response = await fetch(`${API_BASE_URL}${endpoint}`, config);
    } else {
      window.location.href = "/login";
      throw new Error("Authentication failed");
    }
  }

  return response.json();
}

// ë¦¬í”„ë ˆì‹œ í† í°ìœ¼ë¡œ ì•¡ì„¸ìŠ¤ í† í° ê°±ì‹ 
async function refreshAccessToken(): Promise<boolean> {
  const response = await fetch(`${API_BASE_URL}/api/auth/refresh`, {
    method: "POST",
    credentials: "include", // ë¦¬í”„ë ˆì‹œ í† í° ì¿ í‚¤ ìë™ í¬í•¨
  });

  return response.ok; // ì„±ê³µ ì‹œ ìƒˆ accessToken ì¿ í‚¤ ìë™ ì €ì¥
}
```

**credentials: 'include' ë™ì‘**:

1. **Same-Origin**: ìë™ìœ¼ë¡œ ì¿ í‚¤ í¬í•¨ (ê¸°ë³¸ ë™ì‘)
2. **Cross-Origin**: ëª…ì‹œì ìœ¼ë¡œ í•„ìš” (í”„ë¡ íŠ¸ì—”ë“œì™€ ë°±ì—”ë“œê°€ ë‹¤ë¥¸ ë„ë©”ì¸)
3. ë°±ì—”ë“œë„ CORSì—ì„œ `credentials: true` ì„¤ì • í•„ìˆ˜

---

## 3. Server Actionì—ì„œ ì¿ í‚¤ ì²˜ë¦¬

### app/actions/auth.ts

```typescript
"use server";

import { cookies } from "next/headers";

export async function loginAction(formData: FormData) {
  const response = await fetch(`${API_BASE_URL}/api/auth/login`, {
    method: "POST",
    body: JSON.stringify({ email, password }),
    credentials: "include",
  });

  // ğŸª Set-Cookie í—¤ë” íŒŒì‹± ë° Next.js ì¿ í‚¤ë¡œ ì„¤ì •
  const setCookieHeaders = response.headers.getSetCookie();

  if (setCookieHeaders) {
    const cookieStore = await cookies();

    for (const setCookieHeader of setCookieHeaders) {
      parseAndSetCookie(cookieStore, setCookieHeader);
    }
  }

  redirect("/dashboard");
}

// Set-Cookie í—¤ë” íŒŒì‹± í•¨ìˆ˜
function parseAndSetCookie(cookieStore, setCookieHeader) {
  const [nameValue, ...attributes] = setCookieHeader.split(";");
  const [name, value] = nameValue.split("=");

  const options = {
    httpOnly: attributes.includes("HttpOnly"),
    secure: attributes.includes("Secure"),
    sameSite: "lax",
    path: "/",
  };

  // Max-Age, Path ë“± íŒŒì‹±
  attributes.forEach((attr) => {
    if (attr.startsWith("max-age=")) {
      options.maxAge = parseInt(attr.split("=")[1]);
    }
  });

  cookieStore.set(name, value, options);
}
```

**Server Action ì¿ í‚¤ í”Œë¡œìš°**:

1. **ë¸Œë¼ìš°ì € â†’ Next.js**: ìë™ ì¿ í‚¤ ì „ì†¡
2. **Next.js â†’ Backend**: `Cookie` í—¤ë”ì— ëª…ì‹œì  í¬í•¨ í•„ìš”
3. **Backend â†’ Next.js**: `Set-Cookie` ì‘ë‹µ
4. **Next.js â†’ ë¸Œë¼ìš°ì €**: `cookies().set()`ìœ¼ë¡œ ì „ë‹¬

---

## 4. Middlewareì—ì„œ ì¸ì¦ ì²´í¬

### middleware.ts

```typescript
export async function middleware(request: NextRequest) {
  const { pathname } = request.nextUrl;

  // ê³µê°œ ê²½ë¡œëŠ” í†µê³¼
  if (publicPaths.includes(pathname)) {
    return NextResponse.next();
  }

  // ì•¡ì„¸ìŠ¤ í† í° í™•ì¸
  const accessToken = request.cookies.get("accessToken");

  if (!accessToken) {
    // ë¦¬í”„ë ˆì‹œ ì‹œë„
    const refreshResult = await attemptTokenRefresh(request);

    if (refreshResult) {
      return refreshResult; // ìƒˆ ì¿ í‚¤ í¬í•¨ ì‘ë‹µ
    }

    return NextResponse.redirect(new URL("/login", request.url));
  }

  return NextResponse.next();
}

// ë¦¬í”„ë ˆì‹œ í† í°ìœ¼ë¡œ ê°±ì‹ 
async function attemptTokenRefresh(request: NextRequest) {
  const refreshToken = request.cookies.get("refreshToken");

  const response = await fetch(`${API_BASE_URL}/api/auth/refresh`, {
    method: "POST",
    headers: {
      Cookie: `refreshToken=${refreshToken.value}`, // ëª…ì‹œì  ì „ë‹¬
    },
  });

  if (response.ok) {
    const setCookieHeaders = response.headers.getSetCookie();
    const nextResponse = NextResponse.next();

    // ìƒˆ ì¿ í‚¤ë¥¼ ì‘ë‹µì— ì¶”ê°€
    setCookieHeaders.forEach((header) => {
      const [name, value] = header.split(";")[0].split("=");
      nextResponse.cookies.set(name, value, {
        httpOnly: true,
        secure: true,
        sameSite: "lax",
      });
    });

    return nextResponse;
  }

  return null;
}
```

**Middleware ì „ëµ**:

- âœ… ê°„ë‹¨í•œ ì¿ í‚¤ ì¡´ì¬ ì—¬ë¶€ë§Œ ì²´í¬
- âš ï¸ ë³µì¡í•œ ê²€ì¦ì€ í”¼í•˜ê¸° (Edge Runtime ì œì•½)
- âœ… ìƒì„¸ ê²€ì¦ì€ Server Componentsì—ì„œ ìˆ˜í–‰

---

## 5. ìë™ í† í° ê°±ì‹  Hook

### hooks/useAuthRefresh.ts

```typescript
"use client";

export function useAuthRefresh(intervalMinutes: number = 14) {
  useEffect(() => {
    async function refreshToken() {
      const response = await fetch(`${API_BASE_URL}/api/auth/refresh`, {
        method: "POST",
        credentials: "include", // ë¦¬í”„ë ˆì‹œ í† í° ìë™ í¬í•¨
      });

      if (!response.ok) {
        window.location.href = "/login";
      }
    }

    // 14ë¶„ë§ˆë‹¤ ê°±ì‹  (ì•¡ì„¸ìŠ¤ í† í° 15ë¶„ ë§Œë£Œ ê°€ì •)
    const interval = setInterval(refreshToken, intervalMinutes * 60 * 1000);

    return () => clearInterval(interval);
  }, [intervalMinutes]);
}
```

**í† í° ê°±ì‹  ì „ëµ**:

1. **ì£¼ê¸°ì  ê°±ì‹ **: í† í° ë§Œë£Œ ì „ ìë™ ê°±ì‹  (ì˜ˆ: 14ë¶„ë§ˆë‹¤)
2. **401 ì—ëŸ¬ ì‹œ ê°±ì‹ **: API ìš”ì²­ ì‹¤íŒ¨ ì‹œ ì¦‰ì‹œ ì¬ì‹œë„
3. **ê¶Œì¥**: ë‘ ë°©ë²• ì¡°í•© ì‚¬ìš©

---

## 6. ì¸ì¦ í”Œë¡œìš° ë‹¤ì´ì–´ê·¸ë¨

### ë¡œê·¸ì¸ í”Œë¡œìš°

```
Browser â†’ Next.js Server Action
          â†“
        Backend API
          â†“
        Set-Cookie: accessToken, refreshToken
          â†“
        Next.js â†’ Browser
        (ì¿ í‚¤ ìë™ ì €ì¥)
```

### í† í° ë§Œë£Œ & ê°±ì‹  í”Œë¡œìš°

```
Browser â†’ GET /api/users â†’ Backend
                           â†“
                        401 Unauthorized
                           â†“
        POST /api/auth/refresh (refreshToken ì¿ í‚¤ í¬í•¨)
                           â†“
                        Set-Cookie: new accessToken
                           â†“
        GET /api/users (ì¬ì‹œë„)
                           â†“
                        Success
```

---

## 7. ë³´ì•ˆ ì²´í¬ë¦¬ìŠ¤íŠ¸

### ì¿ í‚¤ ì„¤ì •

- âœ… `httpOnly: true` - XSS ë°©ì–´
- âœ… `secure: true` - HTTPS ì „ìš©
- âœ… `sameSite: 'lax'` - CSRF ë°©ì–´
- âœ… Path ë¶„ë¦¬ (accessToken: `/`, refreshToken: `/api/auth/refresh`)

### í† í° ë§Œë£Œ ì‹œê°„

- **Access Token**: 15ë¶„ ~ 1ì‹œê°„
- **Refresh Token**: 7ì¼ ~ 30ì¼

### CSRF ì¶”ê°€ ë°©ì–´

```typescript
// CSRF í† í°ì„ í—¤ë”ì— í¬í•¨
const csrfToken = document.cookie
  .split("; ")
  .find((row) => row.startsWith("XSRF-TOKEN="))
  ?.split("=")[1];

fetch(url, {
  headers: {
    "X-XSRF-TOKEN": csrfToken,
  },
  credentials: "include",
});
```

---

## í•µì‹¬ ì •ë¦¬

### í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ

```typescript
// âœ… credentials: 'include' í•„ìˆ˜
fetch("/api/users", { credentials: "include" });

// âœ… httpOnly ì¿ í‚¤ëŠ” JavaScript ì ‘ê·¼ ë¶ˆê°€
// document.cookieë¡œ ì½ì„ ìˆ˜ ì—†ìŒ

// âœ… 401 ì—ëŸ¬ ì‹œ ìë™ ë¦¬í”„ë ˆì‹œ
```

### Server Actions

```typescript
// âœ… cookies() APIë¡œ ì¿ í‚¤ ì½ê¸°
const cookieStore = await cookies();

// âœ… ë°±ì—”ë“œë¡œ ìš”ì²­ ì‹œ Cookie í—¤ë” í¬í•¨
headers: {
  Cookie: cookieStore.toString();
}

// âœ… Set-Cookie íŒŒì‹± í›„ ì „ë‹¬
cookieStore.set(name, value, options);
```

### Middleware

```typescript
// âœ… ê°„ë‹¨í•œ ì²´í¬ë§Œ ìˆ˜í–‰
const token = request.cookies.get("accessToken");

// âš ï¸ DB ì ‘ê·¼ ë¶ˆê°€ (Edge Runtime)

// âœ… ë¦¬í”„ë ˆì‹œ ì‹œ ìƒˆ ì¿ í‚¤ ì „ë‹¬
response.cookies.set(name, value);
```

---

## í•™ìŠµ ì¸ì‚¬ì´íŠ¸

### credentials: 'include'ì˜ ì¤‘ìš”ì„±

Cross-Origin í™˜ê²½ì—ì„œ ì¿ í‚¤ë¥¼ ìë™ìœ¼ë¡œ ì£¼ê³ ë°›ìœ¼ë ¤ë©´ ë°˜ë“œì‹œ `credentials: 'include'`ê°€ í•„ìš”í•©ë‹ˆë‹¤. ì´ëŠ” ë‹¨ìˆœí•œ ì˜µì…˜ì´ ì•„ë‹ˆë¼ í”„ë¡ íŠ¸ì—”ë“œ-ë°±ì—”ë“œ ë¶„ë¦¬ ì•„í‚¤í…ì²˜ì—ì„œ ì¿ í‚¤ ê¸°ë°˜ ì¸ì¦ì„ ê°€ëŠ¥í•˜ê²Œ í•˜ëŠ” í•µì‹¬ ë©”ì»¤ë‹ˆì¦˜ì…ë‹ˆë‹¤.

### httpOnly ì¿ í‚¤ì˜ ë³´ì•ˆì„±

JavaScriptì—ì„œ ì ‘ê·¼í•  ìˆ˜ ì—†ëŠ” httpOnly ì¿ í‚¤ëŠ” XSS ê³µê²©ìœ¼ë¡œë¶€í„° í† í°ì„ ë³´í˜¸í•©ë‹ˆë‹¤. í•˜ì§€ë§Œ ì´ë¡œ ì¸í•´ Server Actionsì™€ Middlewareì—ì„œ ì¿ í‚¤ë¥¼ ëª…ì‹œì ìœ¼ë¡œ í—¤ë”ì— í¬í•¨ì‹œì¼œì•¼ í•˜ëŠ” ë³µì¡ì„±ì´ ìƒê¹ë‹ˆë‹¤. ë³´ì•ˆê³¼ í¸ì˜ì„± ì‚¬ì´ì˜ íŠ¸ë ˆì´ë“œì˜¤í”„ë¥¼ ì´í•´í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤.

### Server Actionsì˜ í”„ë¡ì‹œ ì—­í• 

Server ActionsëŠ” ë‹¨ìˆœíˆ ì„œë²„ì—ì„œ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜ê°€ ì•„ë‹ˆë¼, ë¸Œë¼ìš°ì €ì™€ ë°±ì—”ë“œ API ì‚¬ì´ì—ì„œ ì¿ í‚¤ë¥¼ ì•ˆì „í•˜ê²Œ ì „ë‹¬í•˜ëŠ” í”„ë¡ì‹œ ì—­í• ì„ í•©ë‹ˆë‹¤. `Set-Cookie` í—¤ë”ë¥¼ íŒŒì‹±í•˜ì—¬ Next.js ì¿ í‚¤ ìŠ¤í† ì–´ì— ì„¤ì •í•˜ëŠ” ê³¼ì •ì€ í´ë¼ì´ì–¸íŠ¸ì™€ ì„œë²„ ê°„ ì¿ í‚¤ ë™ê¸°í™”ì˜ í•µì‹¬ì…ë‹ˆë‹¤.

### í† í° ê°±ì‹ ì˜ ì´ì¤‘ ì „ëµ

ì£¼ê¸°ì  ê°±ì‹ ê³¼ 401 ì—ëŸ¬ ì‹œ ê°±ì‹ ì„ í•¨ê»˜ ì‚¬ìš©í•˜ë©´, ì‚¬ìš©ì ê²½í—˜ì„ í•´ì¹˜ì§€ ì•Šìœ¼ë©´ì„œë„ í† í°ì„ í•­ìƒ ìµœì‹  ìƒíƒœë¡œ ìœ ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” "ì˜ˆë°©ì  ê°±ì‹  + ë°˜ì‘ì  ê°±ì‹ "ì˜ ì¡°í•©ìœ¼ë¡œ, ì‹¤ì „ í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œ ê¶Œì¥ë˜ëŠ” íŒ¨í„´ì…ë‹ˆë‹¤.

---

## ì°¸ê³  ìë£Œ

- [MDN - Fetch API: credentials](https://developer.mozilla.org/en-US/docs/Web/API/fetch#credentials)
- [Next.js ê³µì‹ ë¬¸ì„œ - cookies](https://nextjs.org/docs/app/api-reference/functions/cookies)
- [OWASP - Session Management Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Session_Management_Cheat_Sheet.html)
